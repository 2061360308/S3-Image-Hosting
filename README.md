# S3ImageHosting

![License](https://img.shields.io/badge/license-MIT-blue.svg)
![Version](https://img.shields.io/badge/version-1.0.0-brightgreen.svg)
![Build](https://img.shields.io/badge/build-passing-green.svg)
![PRs Welcome](https://img.shields.io/badge/PRs-welcome-yellowgreen.svg)
![TypeScript](https://img.shields.io/badge/TypeScript-4.0+-blue.svg)
![Stars](https://img.shields.io/github/stars/2061360308/S3-Image-Hosting.svg?color=yellow&style=flat)
![Forks](https://img.shields.io/github/forks/2061360308/S3ImageHosting.svg?color=orange&style=flat)
![Issues](https://img.shields.io/github/issues/2061360308/S3ImageHosting.svg?color=red)

> çº¯å‰ç«¯ã€æµè§ˆå™¨å¯ç”¨ã€è¶…è½»é‡çš„åŸºäºå¯¹è±¡å­˜å‚¨çš„å›¾åºŠç®¡ç†å·¥å…·

<table style="width: 100%;" align="center">
  <tr>
    <td colspan="2" align="center">
      <h2>ç›®å½•</h2>
    </td>
  </tr>
  <tr>
    <td style="text-align: left; display: inline-block;">
      <p><a href='#ç‰¹æ€§-ğŸš€'>ç‰¹æ€§ ğŸš€</a></p>
      <p><a href='#æµ‹è¯•ç»“æœ-âœ…'>æµ‹è¯•ç»“æœ âœ…</a></p>
      <p><a href='#ä½¿ç”¨æ–¹æ³•-ğŸ“š'>ä½¿ç”¨æ–¹æ³• ğŸ“š</a></p>
      <p><a href='#è­¦å‘Š-âš ï¸'>è­¦å‘Š âš ï¸</a></p>
      <p><a href='#å¼€å‘è´¡çŒ®-ğŸ› ï¸'>å¼€å‘&è´¡çŒ® ğŸ› ï¸</a></p>
      <p><a href='#åè®®æˆæƒ-ğŸ“„'>åè®®&æˆæƒ ğŸ“„</a></p>
      <p><a href='#é¸£è°¢-ğŸ™'>é¸£è°¢ ğŸ™</a></p>
    </td>
  </tr>
</table>

## ç‰¹æ€§ ğŸš€

1. [çº¯å‰ç«¯ï¼Œæµè§ˆå™¨å¯ç”¨](#çº¯å‰ç«¯æµè§ˆå™¨å¯ç”¨)
2. [è¶…è½»é‡](#è¶…è½»é‡)
3. [é«˜æ‰©å±•](#é«˜æ‰©å±•)
4. [åŠŸèƒ½å…¨é¢](#åŠŸèƒ½å…¨é¢)
5. [å¤šç§æœåŠ¡æ”¯æŒ](#å¤šç§æœåŠ¡æ”¯æŒ)
6. [TypeScript ç±»å‹é½å…¨](#typescript-ç±»å‹é½å…¨)
7. [æ³¨é‡Šè¯¦å°½](#æ³¨é‡Šè¯¦å°½)
8. [å®Œæ•´æµ‹è¯•ç”¨ä¾‹](#å®Œæ•´æµ‹è¯•ç”¨ä¾‹)
9. [æ¨¡å—åŒ–è®¾è®¡](#æ¨¡å—åŒ–è®¾è®¡)

### çº¯å‰ç«¯ï¼Œæµè§ˆå™¨å¯ç”¨

çº¯å‰ç«¯è¯­è¨€ç¼–å†™ï¼Œå¯ç›´æ¥åœ¨æµè§ˆå™¨ä¸­è°ƒç”¨ï¼Œæ— éœ€åç«¯æ”¯æŒï¼Œæ— éœ€é…ç½®å¤æ‚æœåŠ¡å™¨ã€‚

### è¶…è½»é‡

åªæä¾›åŸºç¡€çš„æ¥å£åŒ…è£…ï¼Œæœªå‹ç¼©å‰ä½“ç§¯ä»… **42.54KB**ï¼ŒåŠ è½½é€Ÿåº¦å¿«ï¼Œæ€§èƒ½ä¼˜å¼‚ã€‚

### é«˜æ‰©å±•

åŒºåˆ«äºä¼ ç»Ÿå›¾åºŠé¡¹ç›®ï¼Œè¯¥åº“ä»…æ˜¯**é’ˆå¯¹æ€§**åœ°å°†å¯¹è±¡å‚¨å­˜åŒ…è£…ä¸ºäº†å¯ä»¥æ–¹ä¾¿ä½¿ç”¨çš„å›¾åºŠç›¸å…³çš„å®ç”¨æ¥å£ï¼Œå¼€å‘è€…å¯ä»¥æ ¹æ®éœ€è¦è‡ªç”±æ‰©å±•å’Œå®šåˆ¶åŠŸèƒ½ï¼Œä»¥æ»¡è¶³ç‰¹å®šçš„ä¸šåŠ¡éœ€æ±‚ã€‚ç”¨æˆ·ä¹Ÿä¸å¿…æ‹…å¿ƒè¿ç§»å¹³å°æ—¶çš„å¤æ‚é—®é¢˜ï¼ŒåŒä½¿ç”¨æ­¤é¡¹ç›®çš„å›¾åºŠå¯ä»¥ç›´æ¥è¿ç§»ï¼Œå°±ç®—è¿ç§»å…¶ä»–å›¾åºŠä¹Ÿèƒ½æ–¹ä¾¿çš„è§£ææœ¬ç±»å›¾åºŠäº§ç”Ÿçš„æ•°æ®ï¼Œä¿è¯æ•°æ®ä¸ä¸¢å¤±

### åŠŸèƒ½å…¨é¢

è¿‘**20 ä¸ª**æ–¹æ³•ï¼Œæä¾›åŒ…æ‹¬ä¸Šä¼ å›¾ç‰‡ã€åˆ é™¤å›¾ç‰‡ã€ç”Ÿæˆå›¾ç‰‡åœ¨çº¿é“¾æ¥ã€ä¾æ®æ ‡ç­¾æˆ–ç›¸å†Œç­›é€‰ã€æ ¹æ®åˆ›å»ºæ—¶é—´æŸ¥çœ‹å›¾ç‰‡ç­‰è¶…å¤šå®ç”¨åŠŸèƒ½ã€‚

### å¤šç§æœåŠ¡æ”¯æŒ

åŸºäºå¯¹è±¡å‚¨å­˜æ„å»ºï¼Œä½¿ç”¨äºšé©¬é€Š S3 æ ‡å‡†æ¥å£ï¼Œå¯å…¼å®¹å¤§éƒ¨åˆ†ä¸»æµå¹³å°ï¼Œå¦‚ï¼š

- è…¾è®¯äº‘ COS
- é˜¿é‡Œäº‘ OSS
- ä¸ƒç‰›äº‘ Kodo
- äºšé©¬é€Š S3

### TypeScript ç±»å‹é½å…¨

æä¾›å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰ï¼Œå¢å¼ºå¼€å‘ä½“éªŒå’Œä»£ç å¯é æ€§ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯ã€‚

### æ³¨é‡Šè¯¦å°½

ä»£ç æ³¨é‡Šè¯¦å°½ï¼Œä¾¿äºç†è§£å’Œç»´æŠ¤ï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€Ÿä¸Šæ‰‹å’ŒäºŒæ¬¡å¼€å‘ã€‚

### å®Œæ•´æµ‹è¯•ç”¨ä¾‹

æä¾›å®Œæ•´çš„æµ‹è¯•ç”¨ä¾‹ï¼Œç¡®ä¿ä»£ç è´¨é‡å’Œç¨³å®šæ€§ï¼Œæ–¹ä¾¿å¼€å‘è€…è¿›è¡Œå•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•ã€‚

### æ¨¡å—åŒ–è®¾è®¡

æ‰€æœ‰é™æ€æ–¹æ³•å‡ç‹¬ç«‹ç¼–å†™ï¼Œå¹¶åœ¨ `index.ts` ä¸­ç»Ÿä¸€å¯¼å…¥å’Œæ³¨å†Œï¼Œä¾¿äºé˜…è¯»æºç ã€ä¿®æ”¹å’Œçµæ´»ä½¿ç”¨é™æ€æ–¹æ³•ã€‚

## æµ‹è¯•ç»“æœ âœ…

> ä½¿ç”¨ vitest ç¼–å†™æµ‹è¯•ï¼Œæ‰€æœ‰æµ‹è¯•å‡åœ¨`src/test`ç›®å½•ä¸‹

![test result](docs/images/test_result.png)

<div align="center">
<a href="docs/testResult.md">@æµ‹è¯•ç”¨ä¾‹ è¯¦ç»†è¾“å‡ºå†…å®¹</a>
</div>

## ä½¿ç”¨æ–¹æ³• ğŸ“š

åˆå§‹åŒ–æ–¹æ³•ç¤ºä¾‹å¦‚ä¸‹

```ts
export const settings: Settings = {
  bucket: process.env.BUCKET as string, // å‚¨å­˜æ¡¶åç§°
  endpoint: process.env.ENDPOINT as string, // æœåŠ¡ç«¯ç‚¹/æœåŠ¡åœ°å€/æœåŠ¡ URL
  region: process.env.REGION as string, // å‚¨å­˜æ¡¶åœ°åŒº
  accessKeyId: process.env.ACCESS_KEY_ID as string, // accessKeyId
  secretAccessKey: process.env.SECRET_ACCESS_KEY as string, // secretAccessKey
};

const s3 = new S3ImageHosting(settings);
```

å¯ä»¥å‚è€ƒå„å¤§å‚å•†çš„è¯´æ˜æ–‡æ¡£

- [è…¾è®¯äº‘ COS](https://cloud.tencent.com/document/product/436/41284)
- [é˜¿é‡Œäº‘ OSS](https://help.aliyun.com/zh/oss/developer-reference/compatibility-with-amazon-s3-1/)
- [ä¸ƒç‰›äº‘ Kodo](https://developer.qiniu.com/kodo/4086/aws-s3-compatible)
- [äºšé©¬é€Š S3](https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/userguide/Welcome.html)

ä»¥ä¸‹ç»™å‡º`S3ImageHosting`çš„æ–¹æ³•æ¨¡å‹

```ts
class S3ImageHosting extends S3ImageHostingMethods {
  readonly version: string;
  settings: Settings;
  client: S3Client;
  constructor(settings: Settings);
  isExistImage: (key: string) => Promise<boolean>;
  uploadImage: (
    fileData: Blob | Buffer | Uint8Array,
    fileType: _ImageType1,
    create: Date,
    update: Date,
    album: string,
    tags: string[]
  ) => Promise<_UploadImageResult1>;
  deleteImage: (hash: string) => Promise<boolean>;
  getImageMetadata: (hash: string) => Promise<Metadata>;
  getImageSignedUrl: (hash: string, expiresIn?: number) => Promise<string>;
  getAllAlbumNames: () => Promise<string[]>;
  addAlbum: (album: Array<string>) => Promise<boolean>;
  removeAlbum: (album: Array<string>) => Promise<boolean>;
  listAlbumItems: (
    albumName: string,
    page: number,
    pageSize: number
  ) => Promise<_PaginatedResult1<string>>;
  albumAddImages: (albumName: string, keys: string[]) => Promise<boolean>;
  albumRemoveImages: (albumName: string, keys: string[]) => Promise<boolean>;
  getAllTagNames: () => Promise<string[]>;
  addTag: (tag: Array<string>) => Promise<boolean>;
  removeTag: (tag: Array<string>) => Promise<boolean>;
  listTagItems: (
    tagName: string,
    page: number,
    pageSize: number
  ) => Promise<_PaginatedResult1<string>>;
  tagAddImages: (tagName: string, keys: string[]) => Promise<boolean>;
  tagRemoveImages: (tagName: string, keys: string[]) => Promise<boolean>;
  listCratedAtItems: (
    page: number,
    pageSize: number
  ) => Promise<_PaginatedResult1<string>>;
}
```

å¤§éƒ¨åˆ†æ–¹æ³•éƒ½æœ‰å¯¹åº”çš„é™æ€æ–¹æ³•ï¼Œå¯ä»¥çµæ´»è°ƒç”¨

```ts
class S3ImageHostingMethods {
  static isExistImageStatic: (
    client: S3Client,
    bucketName: string,
    hash: string
  ) => Promise<boolean>;
  static createMatadataStatic: (
    create: Date,
    update: Date,
    album: string,
    tags: string[]
  ) => Metadata;
  static uploadImageStatic: (
    client: S3Client,
    bucketName: string,
    fileData: Blob | Buffer | Uint8Array,
    fileType: ImageType,
    metadata: Metadata
  ) => Promise<UploadImageResult>;
  static deleteImageStatic: (
    client: S3Client,
    bucketName: string,
    hash: string
  ) => Promise<boolean>;
  static getImageMetadataStatic: (
    client: S3Client,
    bucketName: string,
    hash: string
  ) => Promise<Metadata>;
  static getImageSignedUrlStatic: (
    client: S3Client,
    bucketName: string,
    hash: string,
    expiresIn?: number
  ) => Promise<string>;
  static getAllAlbumNamesStatic: (
    client: S3Client,
    bucketName: string
  ) => Promise<Array<string>>;
  static addAlbumStatic: (
    client: S3Client,
    bucketName: string,
    addNames: Array<string>
  ) => Promise<boolean>;
  static removeAlbumStatic: (
    client: S3Client,
    bucketName: string,
    removeNames: Array<string>
  ) => Promise<boolean>;
  static listAlbumItemsStatic: (
    client: S3Client,
    bucketName: string,
    albumName: string,
    page: number,
    pageSize: number
  ) => Promise<PaginatedResult<string>>;
  static albumAddImagesStatic: (
    client: S3Client,
    bucketName: string,
    albumName: string,
    imageHashs: Array<string>
  ) => Promise<boolean>;
  static albumRemoveImagesStatic: (
    client: S3Client,
    bucketName: string,
    albumName: string,
    imageHashs: Array<string>
  ) => Promise<boolean>;
  static getAllTagNamesStatic: (
    client: S3Client,
    bucketName: string
  ) => Promise<Array<string>>;
  static addTagStatic: (
    client: S3Client,
    bucketName: string,
    addNames: Array<string>
  ) => Promise<boolean>;
  static removeTagStatic: (
    client: S3Client,
    bucketName: string,
    removeNames: Array<string>
  ) => Promise<boolean>;
  static listTagItemsStatic: (
    client: S3Client,
    bucketName: string,
    TagName: string,
    page: number,
    pageSize: number
  ) => Promise<PaginatedResult<string>>;
  static tagAddImagesStatic: (
    client: S3Client,
    bucketName: string,
    TagName: string,
    imageHashs: Array<string>
  ) => Promise<boolean>;
  static tagRemoveImagesStatic: (
    client: S3Client,
    bucketName: string,
    TagName: string,
    imageHashs: Array<string>
  ) => Promise<boolean>;
  static listCratedAtItemsStatic: (
    client: S3Client,
    bucketName: string,
    page: number,
    pageSize: number
  ) => Promise<PaginatedResult<string>>;
}
```

## è­¦å‘Šï¼ï¼ âš ï¸

### isExistImage()

æ ¹æ®æµ‹è¯•è„šæœ¬ `upload&delete.test.ts` çš„æµ‹è¯•ç»“æœæ¥çœ‹ï¼Œåˆ é™¤æ“ä½œç»“æŸåç«‹å³æ£€æµ‹å›¾ç‰‡æ˜¯å¦å­˜åœ¨å¯èƒ½ä¼šè¿”å›é”™è¯¯çš„ç»“æœã€‚

åˆ é™¤æ“ä½œï¼ˆ`deleteImage`ï¼‰è™½ç„¶æ˜¯åœ¨ç­‰å¾…è¯·æ±‚åè¿›è¡Œè¿”å›ï¼Œä½†æ˜¯ç”±äºå¯¹è±¡å‚¨å­˜æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿï¼ŒæŸäº›æ“ä½œï¼ˆå¦‚åˆ é™¤å¯¹è±¡ï¼‰å¯èƒ½ä¼šæœ‰çŸ­æš‚çš„å»¶è¿Ÿï¼Œå¯¼è‡´åœ¨åˆ é™¤æ“ä½œå®Œæˆåç«‹å³æ£€æŸ¥å¯¹è±¡æ˜¯å¦å­˜åœ¨æ—¶ï¼ˆ`isExistImage`ï¼‰ï¼Œä»ç„¶å¯èƒ½è¿”å› trueã€‚

ä¸ºäº†ç¡®ä¿åˆ é™¤æ“ä½œå·²ç»å®Œå…¨ç”Ÿæ•ˆï¼Œå¯ä»¥åœ¨åˆ é™¤æ“ä½œåæ·»åŠ ä¸€ä¸ªçŸ­æš‚çš„å»¶è¿Ÿï¼Œç„¶åå†æ£€æŸ¥å¯¹è±¡æ˜¯å¦å­˜åœ¨ã€‚åœ¨å½“å‰æºç ä¸­ï¼Œæˆ‘åœ¨æµ‹è¯•å‡½æ•°`upload&delete.test.ts`ä¸­æš‚æ—¶æ·»åŠ äº† 500ms çš„å»¶æ—¶ï¼Œæ¥é¿å…è¿™ä¸ªé—®é¢˜ã€‚ä½†è¯·å¤§å®¶ç†è§£è¿™ä¸ä¿è¯æ˜¯ç»å¯¹å®‰å…¨çš„ï¼Œæˆ‘è®¤ä¸ºè¿™ä¸ªå€¼åº”è¯¥ç”±åæœŸå¼€å‘è€…æ ¹æ®è‡ªå·±ä¸šåŠ¡å¯¹é€Ÿç‡çš„éœ€æ±‚è¿›è¡Œè°ƒæ•´ï¼Œæˆ–è€…ä½ åº”è¯¥å°½é‡é¿å…åœ¨è¿›è¡Œåˆ é™¤æ“ä½œåç«‹å³æ£€æµ‹å›¾ç‰‡æ˜¯å¦å­˜åœ¨ã€‚

```js
describe("isExist", () => {
  it("isExist should be false", async () => {
    // æ·»åŠ ä¸€ä¸ªçŸ­æš‚çš„å»¶è¿Ÿï¼Œç¡®ä¿åˆ é™¤æ“ä½œå·²ç»å®Œå…¨ç”Ÿæ•ˆ
    await new Promise((resolve) => setTimeout(resolve, 500));

    let result = await imageHosting.isExistImage("94e2635af500225d");
    console.log("isExist result: ", result);
    expect(result).toBeFalsy();
  });
});
```

> å…¶ä»–åœ°æ–¹ä¹Ÿå¯èƒ½æœ‰äº›è®¸å»¶æ—¶ï¼Œè¯·åœ¨å¼€å‘è¿‡ç¨‹ä¸­æ³¨æ„ç±»ä¼¼è¿™ç§æƒ…å†µ

## å¼€å‘&è´¡çŒ® ğŸ› ï¸

> å‚ä¸å¼€å‘è¯·å…ˆ fork æœ¬é¡¹ç›®åˆ°ä¸ªäººä»“åº“ï¼Œç„¶åå†æ‹‰å–åˆ°æœ¬åœ°ã€‚å¦‚æœä½ ä¸ç¡®å®šæ˜¯å¦è¦æ·»åŠ æŸé¡¹åŠŸèƒ½ï¼Œå¯ä»¥å…ˆå‘èµ·è®¨è®ºè¯¢é—®å¤§å®¶æ„è§ã€‚

è¿›è¡Œæ‰“åŒ…æ„å»ºçš„æ–¹æ³•

```bash
pnpm install
pnpm run build
```

è¿è¡Œæµ‹è¯•çš„æ–¹æ³•

> äº†è§£æœ¬é¡¹ç›®ä½¿ç”¨æ–¹æ³•ä¹Ÿå¯ä»¥å‚è€ƒæµ‹è¯•æ–¹æ³•ä¸­çš„ä½¿ç”¨æ–¹æ³•

```bash
pnpm run test:base  // åŸºç¡€åˆå§‹åŒ–ç±»æµ‹è¯•
pnpm run test:uploadDelete  // å›¾ç‰‡ä¸Šä¼ ä¸‹è½½ï¼Œç”Ÿæˆåœ¨çº¿é“¾æ¥æµ‹è¯•
pnpm run test:album  // æµ‹è¯•ç›¸å†Œç›¸å…³åŠŸèƒ½
pnpm run test:tag  // æµ‹è¯•æ ‡ç­¾ç›¸å…³åŠŸèƒ½
pnpm run test:metadata  // æµ‹è¯•å›¾ç‰‡å…ƒæ•°æ®ç›¸å…³
```

## åè®®&æˆæƒ ğŸ“„

é¡¹ç›®ä½¿ç”¨ MIT å¼€æºåè®®ã€‚

## é¸£è°¢ ğŸ™

### vitest

[vitest](https://vitest.dev/) æ˜¯ä¸€ä¸ªå¿«é€Ÿã€ç°ä»£çš„å‰ç«¯æµ‹è¯•æ¡†æ¶ï¼Œå…·æœ‰æé«˜çš„æ€§èƒ½å’Œä¸°å¯Œçš„åŠŸèƒ½ã€‚å®ƒä¸ Vite ç´§å¯†é›†æˆï¼Œæ”¯æŒ TypeScriptã€ESM å’Œç°ä»£æµè§ˆå™¨ç‰¹æ€§ï¼Œæä¾›äº†å‡ºè‰²çš„å¼€å‘ä½“éªŒã€‚

### parcel

[parcel](https://parceljs.org/) æ˜¯ä¸€ä¸ªé›¶é…ç½®çš„å¿«é€Ÿæ‰“åŒ…å·¥å…·ï¼Œæ”¯æŒç°ä»£ JavaScriptã€TypeScriptã€CSS å’Œ HTML ç­‰å¤šç§èµ„æºç±»å‹ã€‚å®ƒå…·æœ‰å¿«é€Ÿçš„çƒ­æ¨¡å—æ›¿æ¢ï¼ˆHMRï¼‰åŠŸèƒ½ï¼Œèƒ½å¤Ÿæ˜¾è‘—æå‡å¼€å‘æ•ˆç‡ï¼Œå¹¶ä¸”æ”¯æŒä»£ç æ‹†åˆ†å’Œä¼˜åŒ–ï¼Œç”Ÿæˆé«˜æ€§èƒ½çš„ç”Ÿäº§æ„å»ºã€‚

é€šè¿‡ä½¿ç”¨ vitest å’Œ parcelï¼Œå¸®åŠ©æˆ‘èƒ½å¤Ÿå¿«é€Ÿæ„å»ºå’Œæµ‹è¯•é¡¹ç›®ï¼Œæå‡å¼€å‘æ•ˆç‡å’Œä»£ç è´¨é‡ã€‚
